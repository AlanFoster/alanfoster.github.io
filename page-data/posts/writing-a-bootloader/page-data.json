{"componentChunkName":"component---src-templates-post-index-js","path":"/posts/writing-a-bootloader/","result":{"data":{"markdownRemark":{"html":"<p>This article explains how to write a very simple x86 bootloader script which can be used as the entry point to running a custom operating system. It assumes some knowledge of assembly, but hopefully all required knowledge should be available within this stand-alone article.</p>\n<!-- end-excerpt -->\n<h3 id=\"boot-process\" style=\"position:relative;\"><a href=\"#boot-process\" aria-label=\"boot process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Boot Process</h3>\n<p>When an x86 computer turns on, it executes firmware located in motherboard ROM.</p>\n<p>There are two main firmware standards:</p>\n<ul>\n<li>BIOS - \"Basic Input/Output System\" - Older, simpler, but widely supported</li>\n<li>UEFI - \"Unified Extensible Firmware Interface\" - Modern, with more features</li>\n</ul>\n<p>This article will describe in detail how to write a BIOS bootloader, and does not discuss UEFI.</p>\n<h3 id=\"bios-boot\" style=\"position:relative;\"><a href=\"#bios-boot\" aria-label=\"bios boot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BIOS Boot</h3>\n<p>When an x86 cpu boots, the BIOS is loaded from firmware into memory. It performs various operations such as RAM detection, and other hardware detection/initializations - before finally attempting its boot sequence. During the boot sequence, the BIOS attempts to find a boot disk which will load the operating system - via a <em>bootstrap</em> program.</p>\n<p>The BIOS generally checks for bootable disks in a specific order. This is potentially user-configurable, known as its bootdisk hierarchy. For instance, checking in the order: floppy disks, CD-ROM drive, then the first hard drive. The BIOS may handle each disk medium differently. For floppy disks the first 512 bytes are read into memory at a specific location, but extra steps may be required for hard drives which contain master boot record information, and CD-ROMs can be loaded entirely into memory and used as a RAM disk. Regardless of medium, the bootloader script will eventually be loaded at address 0x7C00.</p>\n<p>As the BIOS iterates through the disk hierarchy it attempts find the <strong>first readable 512 bytes</strong> (called its <em>boot sector</em>) which ends with the <strong>magic number 0xAA55</strong>. Once found, the BIOS now gives control to the code which has been copied at address location 0x7C00.</p>\n<p>Why the magic number 0xAA55? This the binary equivalent: 101010100101010. This may also be used to determine if your system is big endian or little endian - as it will read as either 0xAA55 or 0x55AA.</p>\n<h3 id=\"environment\" style=\"position:relative;\"><a href=\"#environment\" aria-label=\"environment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Environment</h3>\n<p>When the BIOS hands over control to your bootloader, the CPU is in 16-bit Real Mode, and the program counter will be running at physical address 0x7c00. Real mode was the only mode before the 80286 Intel processor which introduced protected mode. All processors initially run in real mode, for backwards compatibility purposes.</p>\n<p>In <strong>real mode</strong> you can:</p>\n<ul>\n<li>Access BIOS subroutines</li>\n<li>Access 16 bits</li>\n<li>The CPU can only access 1mb of data</li>\n</ul>\n<p>In <strong>protected mode</strong> you can:</p>\n<ul>\n<li>Use paging, and virtual memory</li>\n<li>Access 32 bits</li>\n<li>Prevent illegal writes to other program's memory that are running at the same time</li>\n<li>Register fault handlers for faulting programs</li>\n<li>Access four privilege levels. Ring 0 being the most unrestricted, and ring 3 being the most restricted</li>\n</ul>\n<h4 id=\"simple-bootloader-example\" style=\"position:relative;\"><a href=\"#simple-bootloader-example\" aria-label=\"simple bootloader example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simple Bootloader example</h4>\n<p>The following examples are written using the nasm assembler.</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> nasm</code></pre>\n              </div>\n            </div>\n          \n<p>Create a new file called <code>boot.asm</code>:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"token comment\">; Simple bootloader example for x86 systems that should print out a simple message to the user</span>\n\nbits <span class=\"token number\">16</span>     <span class=\"token comment\">; We're dealing with 16 bit code</span>\norg <span class=\"token number\">0x7c00</span>  <span class=\"token comment\">; Inform the assembler of the starting location for this code</span>\n\n<span class=\"token label function\">boot:</span>\n    mov <span class=\"token register variable\">si</span>, message <span class=\"token comment\">; Point SI register to message</span>\n    mov <span class=\"token register variable\">ah</span>, <span class=\"token number\">0x0e</span>    <span class=\"token comment\">; Set higher bits to the display character command</span>\n\n<span class=\"token label function\">.loop:</span>\n    lodsb       <span class=\"token comment\">; Load the character within the AL register, and increment SI</span>\n    cmp <span class=\"token register variable\">al</span>, <span class=\"token number\">0</span>   <span class=\"token comment\">; Is the AL register a null byte?</span>\n    je halt     <span class=\"token comment\">; Jump to halt</span>\n    int <span class=\"token number\">0x10</span>    <span class=\"token comment\">; Trigger video services interrupt</span>\n    jmp .loop   <span class=\"token comment\">; Loop again</span>\n\n<span class=\"token label function\">halt:</span>\n    hlt         <span class=\"token comment\">; Stop</span>\n\n<span class=\"token label function\">message:</span>\n    db <span class=\"token string\">\"Howdy!\"</span>, <span class=\"token number\">0</span>\n\n<span class=\"token comment\">; Mark the device as bootable</span>\ntimes <span class=\"token number\">510</span><span class=\"token operator\">-</span>(<span class=\"token operator\">$</span><span class=\"token operator\">-</span><span class=\"token operator\">$</span><span class=\"token operator\">$</span>) db <span class=\"token number\">0</span> <span class=\"token comment\">; Add any additional zeroes to make 510 bytes in total</span>\ndw <span class=\"token number\">0xAA55</span> <span class=\"token comment\">; Write the final 2 bytes as the magic number 0x55aa, remembering x86 little endian</span></code></pre>\n              </div>\n            </div>\n          \n<p>You can compile the above assembly with:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\">nasm -f bin boot.asm -o boot.bin</code></pre>\n              </div>\n            </div>\n          \n<p>At the heart of the above bootloader are various calls to the BIOS to request printing characters to the screen.\nA simplified example of printing to the screen can be shown:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">ah</span>, <span class=\"token number\">0x0e</span>    <span class=\"token comment\">; Set higher bits to the display character command</span>\nmov <span class=\"token register variable\">al</span>, <span class=\"token string\">'a'</span>     <span class=\"token comment\">; Set the lower bits to our character</span>\nint <span class=\"token number\">0x10</span>        <span class=\"token comment\">; Call BIOS video service interrupt, which will output 'a'</span></code></pre>\n              </div>\n            </div>\n          \n<h3 id=\"emulating-x86-hardware\" style=\"position:relative;\"><a href=\"#emulating-x86-hardware\" aria-label=\"emulating x86 hardware permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Emulating x86 hardware</h3>\n<p>It's possible to write the compiled binary above to a disk, and attach it to a real computer. It can instead be easier to make use of x86 emulators, such as <strong>Bochs</strong> or <strong>Qemu</strong>. These emulators will do exactly everything that a real computer would do, but everything is <strong>simulated using software</strong> instead of hardware.</p>\n<h4 id=\"qemu\" style=\"position:relative;\"><a href=\"#qemu\" aria-label=\"qemu permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Qemu</h4>\n<p>Firstly install qemu:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> qemu qemu-kvm</code></pre>\n              </div>\n            </div>\n          \n<p>Within the same directory as your code:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\">nasm -f bin boot.asm -o boot.bin\nqemu-system-x86_64 -fda boot.bin</code></pre>\n              </div>\n            </div>\n          \n<p>After running you should see the simple message appear:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3989d9f475946ae5608481afa2633488/073e9/howdy-qemu.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.576687116564415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1UlEQVQ4y+2RyWqGQBCE3cF915dVURDx3TyoiNvTVFINhuSWkP+QQwY+qqnp6YVR5nnGuq7Ytg33feO6LuE4DmHfdzCH+nifOc8Ty7II0zRBqesaTdOg6zoMw4BxHNH3Peg/8I45VVV9QP+JeUfatoXyfvBSPM8DcRwHYRhKHEWRxNQkSRAEgRDHMYqiEC9NU2RZJkr4TtM0KIZhwDRNwbIs0V9NyOrsmuc5yrKUbr7vw3Vd6crYtu3vF+TYXJdwRV3XvySoqvqzCbnmiz9G+S/4xwq+ARPDWPu5Gu3AAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"howdy qemu\"\n        title=\"Example of howdy! being rendered to the qemu emulator\"\n        src=\"/static/3989d9f475946ae5608481afa2633488/a6d36/howdy-qemu.png\"\n        srcset=\"/static/3989d9f475946ae5608481afa2633488/222b7/howdy-qemu.png 163w,\n/static/3989d9f475946ae5608481afa2633488/ff46a/howdy-qemu.png 325w,\n/static/3989d9f475946ae5608481afa2633488/a6d36/howdy-qemu.png 650w,\n/static/3989d9f475946ae5608481afa2633488/073e9/howdy-qemu.png 719w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4 id=\"bochs\" style=\"position:relative;\"><a href=\"#bochs\" aria-label=\"bochs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bochs</h4>\n<p>Firstly install bochs:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> bochs bochs-x</code></pre>\n              </div>\n            </div>\n          \n<p>Within the same directory as your code, create a file <code>bochsrc.txt</code>:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">megs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">32</span>\n<span class=\"token key atrule\">romimage</span><span class=\"token punctuation\">:</span> file=/usr/share/bochs/BIOS<span class=\"token punctuation\">-</span>bochs<span class=\"token punctuation\">-</span>latest<span class=\"token punctuation\">,</span> address=0xfffe0000\n<span class=\"token key atrule\">vgaromimage</span><span class=\"token punctuation\">:</span> file=/usr/share/bochs/VGABIOS<span class=\"token punctuation\">-</span>lgpl<span class=\"token punctuation\">-</span>latest\n<span class=\"token key atrule\">floppya</span><span class=\"token punctuation\">:</span> 1_44=boot.bin<span class=\"token punctuation\">,</span> status=inserted\n<span class=\"token key atrule\">boot</span><span class=\"token punctuation\">:</span> a\n<span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span> bochsout.txt\n<span class=\"token key atrule\">logprefix</span><span class=\"token punctuation\">:</span> %t<span class=\"token punctuation\">-</span>%e<span class=\"token punctuation\">-</span>@%i<span class=\"token punctuation\">-</span>%d\n<span class=\"token key atrule\">mouse</span><span class=\"token punctuation\">:</span> enabled=0\n<span class=\"token key atrule\">display_library</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">,</span> options=\"gui_debug\"</code></pre>\n              </div>\n            </div>\n          \n<p>Now you can run:</p>\n\n            <div class=\"code-snippet\">\n              \n              <div class=\"gatsby-highlight\">\n                <pre class=\"language-bash\"><code class=\"language-bash\">nasm -f bin boot.asm -o boot.bin\nbochs</code></pre>\n              </div>\n            </div>\n          \n<p>After running you should see the simple message appear:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3103c6858bbc5a1ee08d0b355b946bfe/073e9/howdy-bochs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.87116564417178%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVQ4y6WRS04CQRRFq4tf003zkyb8jcapGyABoSFxDQ6YmsDIIRImhB24A0YoToRE4xoYEkJEEkUgzo0LuL7qVsRP/A5O3qvq6lv3vmKTqysIron7+RyPDw+Y391hNp2+qdObG8xubzGfzTAYDDAajTAejzEcDrFYLDCZTNDv98H29vdRqlRwUK/jqNVC5+IC7V4Px92uBfXtszOcnJ/j9PISrU4HtcNDNJtNlMtllEol1Go1NBoNVKtVMB6NgkcisKdSYMEgmMtloShgmgbm81m932/B2NdoW1vQNjehrq9DTSSgkLgaj0NNJiGvrUGiQ6twSQLn3ESiXnq3Zk5y6CIBmQTcJOre2IBMVawV6rksf+9qFR+5EKgUxxMIwEuxA+EwPF4vHG43uN1uHjRvFw6f3bxgs9lMloJJihkmAT0UQjwWQ4wcJ8hxlKroQ7Rvftd1a4/OKDRTF81ZVI3mrKrqq6CdHIgbRH3B4XAs57OKcPRtZD9F9dFLeimi6IMUWdz8q7mtIiIEaHZOp3MZ489igk+j2Sga//gAP4H9y81nZDIZpNNpZLNZFItF7BZ3sZ3fhr6jw9gxzP1cLgfDMJDP5836vi8UCua/oj4BIIB1uzgIvbkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"howdy bochs\"\n        title=\"Example of howdy! being rendered to the bochs emulator\"\n        src=\"/static/3103c6858bbc5a1ee08d0b355b946bfe/a6d36/howdy-bochs.png\"\n        srcset=\"/static/3103c6858bbc5a1ee08d0b355b946bfe/222b7/howdy-bochs.png 163w,\n/static/3103c6858bbc5a1ee08d0b355b946bfe/ff46a/howdy-bochs.png 325w,\n/static/3103c6858bbc5a1ee08d0b355b946bfe/a6d36/howdy-bochs.png 650w,\n/static/3103c6858bbc5a1ee08d0b355b946bfe/073e9/howdy-bochs.png 719w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"entering-protected-mode\" style=\"position:relative;\"><a href=\"#entering-protected-mode\" aria-label=\"entering protected mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entering protected mode</h3>\n<p>To enter protected mode you must:</p>\n<ul>\n<li>\n<p>Register 3 entries in the GDT (Global Descriptor Table)</p>\n<ul>\n<li>null descriptor</li>\n<li>code segment descriptor</li>\n<li>data segment descriptor</li>\n</ul>\n</li>\n<li>Set the protected mode bit within the control register, <code>CR0</code></li>\n<li>Enable the A20 line, or addressing line 20, so that the CPU can access beyond 1mb of data</li>\n</ul>\n<p>The <code>lgdt</code> instruction takes a pointer to a structure in memory that is composed of two parts:</p>\n<ul>\n<li>size (2 bytes)</li>\n<li>offset (4 bytes)</li>\n</ul>\n<p>Each entry within the GDT is 8-bytes. A simple overview can be found on the osdev wiki - <a href=\"https://wiki.osdev.org/Global_Descriptor_Table\">Global Descriptor Table</a></p>\n<h3 id=\"x86nasm-cheat-sheet\" style=\"position:relative;\"><a href=\"#x86nasm-cheat-sheet\" aria-label=\"x86nasm cheat sheet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>x86/nasm Cheat sheet</h3>\n<p><strong>Register names</strong></p>\n<ol>\n<li>Accumulator Register (AX)</li>\n<li>Counter Register (CX)</li>\n<li>Data Register (DX)</li>\n<li>Base Register (DX)</li>\n<li>Stack Pointer (SP)</li>\n<li>Stack base Pointer (BP)</li>\n<li>Source Index (SI)</li>\n<li>Destination Index (DI)</li>\n</ol>\n<p><strong>Global Descriptor Table</strong></p>\n<ul>\n<li>Supplied by the kernel</li>\n<li>Defines the various memory segments, what their size is, what they can access, what level they are</li>\n</ul>\n<p><strong>Interrupt Descriptor Table</strong></p>\n<ul>\n<li>Supplied by the kernel</li>\n<li>Used to map interrupt vectors to functions, which handle events. i.e. Keydown</li>\n</ul>\n<p><strong>String instructions</strong></p>\n<ul>\n<li>The first three letters specify what the instruction, the suffix <code>S</code> stands for String - MOVS, LODS, STOS, CMPS, SCAS.</li>\n<li>LOD - Load data from the string pointed to ESI into EAX</li>\n<li>STO - Store data from EAX into the string pointed to by EDI</li>\n<li>SCA - Scans the data in the string pointed to by EDI to EAX</li>\n<li>ESI and DSI are incremented if the direction flag is set, otherwise decremented</li>\n</ul>\n<p><strong>BIOS Calls</strong></p>\n<ul>\n<li>Generally set the AH register</li>\n<li>Call the required interrupt, i.e. <code>int 0x10</code></li>\n<li>No longer available in protected mode</li>\n</ul>\n<p><strong>Labels</strong></p>\n<ul>\n<li>A global label is defined as <code>name:</code></li>\n<li>A label prefixed with <code>.</code> is local to the above global label, i.e. <code>.loop</code></li>\n</ul>\n<p><strong>Pseudo-instructions</strong></p>\n<ul>\n<li>DB, DW, DD, DQ, DT, DO, DY and DZ declare initialized data in the output file.</li>\n<li>$ evaluates to the assembly position at the beginning of the line containing the expression</li>\n<li>$$ evaluates to the beginning of the current section; so you can tell how far into the section you are by using ($-$$)</li>\n</ul>\n<h3 id=\"useful-links\" style=\"position:relative;\"><a href=\"#useful-links\" aria-label=\"useful links permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a> Useful links</h3>\n<ul>\n<li><a href=\"http://joebergeron.io/posts/post_two.html\">Writing a Tiny x86 Bootloader</a></li>\n<li><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm\">MIT Operating System Engineering</a></li>\n<li><a href=\"https://os.phil-opp.com/\">Writing a Rust OS</a></li>\n<li><a href=\"https://nasm.us/doc/nasmdoc3.html\">Nasm overview</a></li>\n<li><a href=\"https://en.wikibooks.org/wiki/X86_Assembly/Bootloaders\">x86 Bootloader Wiki</a></li>\n<li><a href=\"http://3zanders.co.uk/2017/10/13/writing-a-bootloader/\">Writing an x86 bootloader</a></li>\n<li><a href=\"https://medium.com/@ophirharpaz/a-summary-of-x86-string-instructions-87566a28c20c\">Summary of x86 String instructions</a></li>\n<li><a href=\"http://www.roesler-ac.de/wolfram/acro/credits.htm#1\">Unix Acronym List</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/BIOS_interrupt_call\">Available x86 BIOS calls</a></li>\n<li><a href=\"https://en.wikibooks.org/wiki/X86_Assembly/X86_Architecture\">x86 Registers</a></li>\n<li><a href=\"https://www.cs.bham.ac.uk/~exr/lectures/opsys/10_11/lectures/os-dev.pdf\">OS Dev - Writing a simple operating system from scratch</a></li>\n</ul>","frontmatter":{"title":"Writing a simple x86 BIOS bootloader","date":"01 December, 2019"},"fields":{"slug":"/posts/writing-a-bootloader/","editURL":"https://github.com/AlanFoster/alanfoster.github.io/edit/develop/src/pages/posts/writing-a-bootloader/index.markdown"}}},"pageContext":{"sidebarPath":null,"slug":"/posts/writing-a-bootloader/"}},"staticQueryHashes":[]}