{"data":{"content":{"id":"89a60f37-fd77-50b9-841a-ac14f39e7ba5","frontmatter":{"title":"Running react unit tests within docker","workshop":null,"date":"03 June, 2017"},"fields":{"slug":"/posts/running-react-unit-tests-within-docker/"},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Docker is a great way to provide a consistent environment for running your development environment, test suite, as well as your production servers. It provides an easy method of specifying the environment requirements, dependencies, as well as your required linux distribution."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For instance; If you are making use of automated tests as part of your Continuous Integration pipeline, it can be useful to know how to run your JavaScript tests within a docker container."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"your-application"},"children":[{"type":"element","tagName":"a","properties":{"href":"#your-application","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Your application"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This post assumes that you have a React/JavaScript application ready to be tested."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For this post I will assume that we're using "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/react-community/create-react-native-app"},"children":[{"type":"text","value":"create-react-native-app"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"npm install -g create-react-app\ncreate-react-app my-app\ncd my-app"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You should be able to confirm that your react application is running as expected with:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ npm start\n\nCompiled successfully!\n\nYou can now view my-app in the browser.\n\n  Local:            http://localhost:3000/\n  On Your Network:  http://192.168.1.160:3000/"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You should be able to confirm that all tests are running as expected with:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ npm test\n\n PASS  src/App.test.js\n  ✓ renders without crashing (24ms)\n\nTest Suites: 1 passed, 1 total\nTests:       1 passed, 1 total\nSnapshots:   0 total\nTime:        1.14s\nRan all test suites related to changed files.\n\nWatch Usage\n › Press p to filter by a filename regex pattern.\n › Press t to filter by a test name regex pattern.\n › Press q to quit watch mode.\n › Press Enter to trigger a test run."}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"h3","properties":{"id":"installing-docker"},"children":[{"type":"element","tagName":"a","properties":{"href":"#installing-docker","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Installing docker"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The first step is installing docker. The specific installation steps will be different if you are on a windows machine, mac, etc."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Please see the latest install steps at "},{"type":"element","tagName":"a","properties":{"href":"https://www.docker.com"},"children":[{"type":"text","value":"https://www.docker.com"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You should be able to verify that your local install is running with:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ docker run hello-world\n\nlatest: Pulling from library/hello-world\n78445dd45222: Pull complete\nDigest: sha256:c5515758d4c5e1e838e9cd307f6c6a0d620b5e07e6f927b07d05f6d12a1ac8d7\nStatus: Downloaded newer image for hello-world:latest\n\nHello from Docker!"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"h3","properties":{"id":"containers-and-images"},"children":[{"type":"element","tagName":"a","properties":{"href":"#containers-and-images","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Containers and images"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A docker image is the built blueprint of the environment that you want. It is built from a "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Dockerfile"}]},{"type":"text","value":" which specifies the environment and software requirements."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A container is a running instance of a docker image. There can be many instances of the same docker image."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"creating-a-docker-file"},"children":[{"type":"element","tagName":"a","properties":{"href":"#creating-a-docker-file","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Creating a docker file"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Docker depends on having a "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Dockerfile"}]},{"type":"text","value":" which specifies the environment and software requirements."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Create a new Docker file with:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"touch Dockerfile"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With the following content:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-docker"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-docker"]},"children":[{"type":"text","value":"FROM node:8.0.0-alpine\n\nRUN mkdir /srv/example\nWORKDIR /srv/example\n\nCOPY package.json yarn.lock ./\nRUN yarn && yarn cache clean\nCOPY . ."}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Docker will run sequentially through each line within the docker file."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"FROM node:8.0.0-alpine"}]},{"type":"text","value":" - For our application we wish to run on an environment that has node and yarn installed. Thankfully this is a common requirement and there are various base docker images that can be used and searched for within the "},{"type":"element","tagName":"a","properties":{"href":"https://hub.docker.com/"},"children":[{"type":"text","value":"docker hub"}]},{"type":"text","value":". In our case we can specify a node version from the "},{"type":"element","tagName":"a","properties":{"href":"https://hub.docker.com/_/node/"},"children":[{"type":"text","value":"node official repository"}]},{"type":"text","value":". In particular we will make use of the Alpine linux distro, which is small - at only around 5MB."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"RUN mkdir /srv/app"}]},{"type":"text","value":" - Create a new folder to contain our application"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"WORKDIR /srv/app"}]},{"type":"text","value":" - Specify the working directory for future commands such as "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"ADD"}]},{"type":"text","value":", etc."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"COPY package.json yarn.lock ./"}]},{"type":"text","value":" - Place the required dependency files onto our image. Note that the copy command follows the pattern "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"COPY <src>... <dest>"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"RUN yarn && yarn cache clean"}]},{"type":"text","value":" Install our dependencies and remove the cache in one operation."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"COPY . ."}]},{"type":"text","value":" Copy the rest of the files within our daemon context into our working directory."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Remember: With Docker, order matters. Docker will run each instruction independently, and if possible Docker will attempt to re-use intermediate steps if possible. This is why we chose to copy across our "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"package.json"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"yarn.lock"}]},{"type":"text","value":" before running the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"yarn"}]},{"type":"text","value":" install command. Importantly, we wish for any changes to these files to invalidate the next docker step and download the updated dependencies. However we don't wish to download our dependencies again if other unrelated files change. The atomic nature of the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" command explains explains why we delete our yarn cache too, as we don't want for these files to be cached by Docker and create an necessarily large docker image."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"reducing-files-sent-to-the-docker-daemon"},"children":[{"type":"element","tagName":"a","properties":{"href":"#reducing-files-sent-to-the-docker-daemon","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Reducing files sent to the docker daemon"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When building a docker image the current directory's contents are sent to the running docker daemon. If you are working in a local development environment this can be a bad idea. For instance this may copy across all of the contents of your "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"node_modules"}]},{"type":"text","value":" directory leading to slow docker build times. Even worse there is the potential of copying various "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".env"}]},{"type":"text","value":" files into your docker container - which could contain environment variables such as keys and passwords that you definitely do not want to distribute by accident."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Thankfully, similar to a "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".gitignore"}]},{"type":"text","value":" file, you can specify a "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".dockerignore"}]},{"type":"text","value":" file."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Create a new "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".dockerignore"}]},{"type":"text","value":" file with the following content:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"# Ignore all files by default\n*\n\n# White list only the required files\n!src/\n!public/\n!package.json\n!yarn.lock"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In my experience I prefer white-listing rather than black listing files for docker. It is better for a docker build to break because you forgot to white list an additional dependency, than it is to have secrets shared without realizing."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Note"}]},{"type":"text","value":": If you are creating a dockerignore file for your own project, you may wish to include additional files such as "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".babelrc"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".eslint"}]},{"type":"text","value":" etc. Particularly if you are planning to run linting rules as part of your CI pipeline."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"using-docker-compose"},"children":[{"type":"element","tagName":"a","properties":{"href":"#using-docker-compose","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Using docker compose"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Docker compose allows you to manage multi-container docker applications. In our case we can use it to build our image and run a one-of command to verify that our tests are working."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Create a new file "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":" with the content:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"text","value":"version: '3'\n\nservices:\n  test:\n    build:\n      context: .\n    environment:\n      - CI=true\n    command: npm test"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The following commands will now build our image, as well as execute "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"npm test"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ docker-compose build test\n\n...\n\n$ docker-compose run --rm test\n\nnpm info it worked if it ends with ok\nnpm info using npm@5.0.0\nnpm info using node@v8.0.0\nnpm info lifecycle my-app@0.1.0~pretest: my-app@0.1.0\nnpm info lifecycle my-app@0.1.0~test: my-app@0.1.0\n\n> my-app@0.1.0 test /srv/example\n> react-scripts test --env=jsdom\n\n PASS  src/App.test.js\n  ✓ renders without crashing (29ms)\n\nTest Suites: 1 passed, 1 total\nTests:       1 passed, 1 total\nSnapshots:   0 total\nTime:        1.284s\nRan all test suites.\nnpm info lifecycle my-app@0.1.0~posttest: my-app@0.1.0\nnpm info ok"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note that within our docker-compose file we also needed to specify the environment variable "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"CI=true"}]},{"type":"text","value":" - otherwise by default jest will run in "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"--watch"}]},{"type":"text","value":" mode."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Additionally we have specified the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"--rm"}]},{"type":"text","value":" option within our run command, to delete our container after the command completes."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Importantly, if our test fails - the correct status code will be returned. This is useful to break your build in a CI environment:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ docker-compose run --rm test\n\n...\n\n FAIL  src/App.test.js\n  ● renders without crashing\n\n$ echo $?\n1"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"h3","properties":{"id":"docker-for-development"},"children":[{"type":"element","tagName":"a","properties":{"href":"#docker-for-development","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Docker for development"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It is also possible to use docker for development. This is useful when you wish for all developers to have the same development environment, and as close to production as possible."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can modify the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":" file to have an additional "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":" service:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"text","value":"version: '3'\n\nservices:\n  dev:\n    build:\n      context: .\n    ports:\n      - 3000:3000\n    command: npm start\n    volumes:\n      - \"./src:/srv/example/src\"\n\n  test:\n    build:\n      context: .\n    environment:\n      - CI=true\n    command: npm test"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This adds an additional "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dev"}]},{"type":"text","value":" service which will run "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"npm start"}]},{"type":"text","value":", and expose port 3000 within the docker container onto port 3000 on the host machine."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"An important addition is the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"volumes"}]},{"type":"text","value":" keys, which maps the current host machine's src directory onto "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"/srv/example/src"}]},{"type":"text","value":" within the docker container. This means that any local file changes will reflected within our docker container. This is useful as by default the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"create-react-app"}]},{"type":"text","value":" has hot module reloading enabled, and any code changes made on the host machine will automatically reload your browser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can run this container with:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ docker-compose build dev\n\n...\n\n$ docker-compose up dev\n\nCreating myapp_dev_1\nAttaching to myapp_dev_1\ndev_1   | npm info it worked if it ends with ok\ndev_1   | npm info using npm@5.0.0\ndev_1   | npm info using node@v8.0.0\ndev_1   | npm info lifecycle my-app@0.1.0~prestart: my-app@0.1.0\ndev_1   | npm info lifecycle my-app@0.1.0~start: my-app@0.1.0\ndev_1   |\ndev_1   | > my-app@0.1.0 start /srv/example\ndev_1   | > react-scripts start\ndev_1   |\ndev_1   | Starting the development server...\ndev_1   |\ndev_1   | Compiled successfully!\ndev_1   |\ndev_1   | You can now view my-app in the browser.\ndev_1   |\ndev_1   |   Local:            http://localhost:3000/\ndev_1   |   On Your Network:  http://172.20.0.2:3000/\ndev_1   |\ndev_1   | Note that the development build is not optimized.\ndev_1   | To create a production build, use yarn run build.\ndev_1   |"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note that we are making use of "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker-compose up"}]},{"type":"text","value":" rather than the previous "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"run"}]},{"type":"text","value":" command."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"create-a-makefile"},"children":[{"type":"element","tagName":"a","properties":{"href":"#create-a-makefile","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Create a makefile"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It's never fun to remember arbitrary commands. Let's introduce a makefile to streamline the dev process:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":".PHONY: dev test help\n.DEFAULT_GOAL: help\n\ndefault: help\n\nhelp: ## Output available commands\n\t@echo \"Available commands:\"\n\t@echo\n\t@fgrep -h \"##\" $(MAKEFILE_LIST) | fgrep -v fgrep | sed -e 's/\\\\$$//' | sed -e 's/##//'\n\ndev:  ## Run a development environment on port 3000\n\t@docker-compose build dev\n\t@docker-compose up dev\n\ntest: ## Run the current test suite\n\t@docker-compose build test\n\t@docker-compose run --rm test"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Note"}]},{"type":"text","value":": Makefiles should use tabs, rather than spaces."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If we're unsure what commands are available to us, we can just run "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"make help"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"Available commands:\n\nhelp:  Output available commands\ndev:   Run a development environment on port 3000\ntest:  Run the current test suite"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For instance, to run the test target you can use:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"make test"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"h3","properties":{"id":"sources"},"children":[{"type":"element","tagName":"a","properties":{"href":"#sources","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Sources"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The full source code can be found at "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/AlanFoster/create-react-app-docker-unit-tests"},"children":[{"type":"text","value":"create-react-app-docker-unit-tests"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"additional-useful-docker-commands"},"children":[{"type":"element","tagName":"a","properties":{"href":"#additional-useful-docker-commands","ariaHidden":true,"className":["anchor"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Additional useful Docker commands"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To view all of the currently running docker instances:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"docker ps"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To open an interactive terminal into one of your running instances:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"docker exec -it DOCKER_PID /bin/sh"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To create a temporary docker container, enter a shell, then delete the container after:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"docker run -it --rm IMAGE_NAME /bin/sh"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          \n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To view the available docker logs:"}]},{"type":"text","value":"\n\n            "},{"type":"element","tagName":"div","properties":{"className":["code-snippet"]},"children":[{"type":"text","value":"\n              \n              "},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"]},"children":[{"type":"text","value":"\n                "},{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"docker logs -f DOCKER_PID"}]}]},{"type":"text","value":"\n              "}]},{"type":"text","value":"\n            "}]},{"type":"text","value":"\n          "}],"data":{"quirksMode":false}}}},"pageContext":{"slug":"/posts/running-react-unit-tests-within-docker/"}}